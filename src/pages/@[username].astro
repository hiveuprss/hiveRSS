---
import Base from '../layouts/Base.astro';
import { getProfile, getUserPosts } from '../lib/hive';

const { username } = Astro.params;

const [profile, posts] = await Promise.all([
  getProfile(username!),
  getUserPosts(username!, 'blog', 20).catch(() => []),
]);

if (!profile) {
  return new Response('Author not found', { status: 404 });
}

const feedUrl  = `https://hiverss.com/@${username}.xml`;
const peakdUrl = `https://peakd.com/@${username}`;

function fmtDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric', month: 'short', day: 'numeric',
  });
}

function fmt(n: number): string {
  if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(1)}M`;
  if (n >= 1_000)     return `${(n / 1_000).toFixed(1)}K`;
  return String(n ?? 0);
}

const repScore = Math.round(profile.reputation ?? 25);
const displayName = username!;
---

<Base
  title={`@${displayName} on Hive — HiveRSS`}
  description={profile.about || `Follow @${displayName}'s posts on Hive via RSS. ${profile.post_count ?? 0} posts, ${fmt(profile.followers ?? 0)} followers.`}
  ogImage={profile.profile_image}
>
  <main>

    <!-- ── Author header ── -->
    <section class="author-header">
      {profile.cover_image && (
        <div class="cover" style={`background-image: url(${profile.cover_image})`}></div>
      )}
      <div class="author-header-inner">
        <div class="author-left">
          <div class="avatar-wrap">
            {profile.profile_image
              ? <img class="avatar" src={profile.profile_image} alt={`@${displayName}`} width="80" height="80" loading="eager" />
              : <div class="avatar avatar-placeholder">{displayName[0].toUpperCase()}</div>
            }
            <span class="rep-badge" title="Reputation">{repScore}</span>
          </div>
          <div class="author-info">
            <h1>@{displayName}</h1>
            {profile.about && <p class="author-bio">{profile.about}</p>}
            <div class="author-meta">
              {profile.location && (
                <span class="meta-item">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                  {profile.location}
                </span>
              )}
              {profile.website && (
                <a class="meta-item meta-link" href={profile.website} target="_blank" rel="noopener noreferrer">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                  {profile.website.replace(/^https?:\/\//, '')}
                </a>
              )}
              <a class="meta-item meta-link" href={peakdUrl} target="_blank" rel="noopener">
                View on PeakD ↗
              </a>
            </div>
          </div>
        </div>

        <div class="author-right">
          <div class="author-stats">
            <div class="stat">
              <span class="stat-value">{fmt(profile.followers ?? 0)}</span>
              <span class="stat-label">followers</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat">
              <span class="stat-value">{fmt(profile.post_count ?? 0)}</span>
              <span class="stat-label">posts</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat">
              <span class="stat-value">{fmt(profile.following ?? 0)}</span>
              <span class="stat-label">following</span>
            </div>
          </div>

          <div class="author-actions">
            <a href={feedUrl} class="rss-btn" target="_blank" rel="noopener">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19.01 7.38 20 6.18 20C4.98 20 4 19.01 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/>
              </svg>
              Subscribe via RSS
            </a>

            <div class="feed-url-row">
              <code id="feed-url-code">{feedUrl}</code>
              <button id="copy-btn" class="copy-btn-sm" aria-label="Copy" title="Copy feed URL">
                <svg id="icon-copy" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg id="icon-check" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </button>
            </div>

            <div class="feed-types">
              <span class="feed-types-label">Also:</span>
              <a href={`/@${username}/feed.xml`} class="feed-type-pill">feed</a>
              <a href={`/@${username}/comments.xml`} class="feed-type-pill">comments</a>
              <a href={`/@${username}/votes.xml`} class="feed-type-pill">votes</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ── Posts ── -->
    <section class="posts-section">
      <div class="posts-inner">
        <div class="posts-header">
          <h2>Recent posts</h2>
          <span class="posts-count">{posts.length} posts</span>
        </div>

        {posts.length === 0 ? (
          <p class="no-posts">No posts found.</p>
        ) : (
          <div class="post-list">
            {posts.map((post, i) => (
              <a
                class="post-item"
                href={`https://peakd.com${post.url}`}
                target="_blank"
                rel="noopener"
              >
                <span class="post-index">{String(i + 1).padStart(2, '0')}</span>
                <div class="post-body">
                  <h3 class="post-title">{post.title || `@${post.author}/${post.permlink}`}</h3>
                  <div class="post-meta">
                    <span class="post-tag">#{post.category}</span>
                    <span class="post-sep">·</span>
                    <span class="post-date">{fmtDate(post.created)}</span>
                  </div>
                </div>
                <span class="post-arrow">↗</span>
              </a>
            ))}
          </div>
        )}
      </div>
    </section>

  </main>
</Base>

<script>
  const code     = document.getElementById('feed-url-code')!;
  const copyBtn  = document.getElementById('copy-btn')!;
  const iconCopy = document.getElementById('icon-copy')!;
  const iconChk  = document.getElementById('icon-check')!;

  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(code.textContent || '');
      iconCopy.style.display = 'none';
      iconChk.style.display  = 'block';
      copyBtn.classList.add('copied');
      setTimeout(() => {
        iconCopy.style.display = 'block';
        iconChk.style.display  = 'none';
        copyBtn.classList.remove('copied');
      }, 2000);
    } catch { /* fallback */ }
  });
</script>

<style>
  main { flex: 1; }

  /* ── Header ── */
  .author-header { border-bottom: 1px solid var(--border); }

  .cover {
    height: 160px;
    background-size: cover;
    background-position: center;
    position: relative;
  }
  .cover::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, transparent 40%, rgba(11,11,10,0.7));
  }

  .author-header-inner {
    max-width: var(--max-w);
    margin: 0 auto;
    padding: 2rem 2rem 2.5rem;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 3rem;
    align-items: start;
  }

  .author-left { display: flex; align-items: flex-start; gap: 1.25rem; }

  .avatar-wrap { position: relative; flex-shrink: 0; }

  .avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid var(--border-bright);
    object-fit: cover;
    display: block;
  }
  .avatar-placeholder {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid var(--border-bright);
    background: var(--surface-3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 2rem;
    color: var(--text-muted);
  }

  .rep-badge {
    position: absolute;
    bottom: -4px;
    right: -4px;
    background: var(--surface-2);
    border: 1px solid var(--border-bright);
    border-radius: 999px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.7rem;
    color: var(--amber);
    padding: 0.1rem 0.35rem;
    line-height: 1.4;
  }

  .author-info { flex: 1; }

  h1 {
    font-size: clamp(1.5rem, 3vw, 2.25rem);
    font-weight: 800;
    letter-spacing: -0.025em;
    color: var(--text);
    margin-bottom: 0.5rem;
  }

  .author-bio {
    font-size: 0.9375rem;
    color: var(--text-muted);
    line-height: 1.55;
    max-width: 480px;
    margin-bottom: 0.75rem;
  }

  .author-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.875rem;
  }
  .meta-item {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.8125rem;
    color: var(--text-dim);
  }
  .meta-link { transition: color 0.15s; }
  .meta-link:hover { color: var(--text-muted); }

  /* Right side */
  .author-right {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    min-width: 220px;
  }

  .author-stats {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.125rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }
  .stat { text-align: center; }
  .stat-value {
    display: block;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 1.125rem;
    color: var(--text);
    letter-spacing: -0.02em;
  }
  .stat-label {
    display: block;
    font-size: 0.7rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .stat-divider { width: 1px; height: 1.75rem; background: var(--border-bright); }

  .author-actions { display: flex; flex-direction: column; gap: 0.625rem; }

  .rss-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.65rem 1.125rem;
    background: var(--red);
    color: #fff;
    font-weight: 600;
    font-size: 0.9rem;
    border-radius: 8px;
    transition: background 0.15s, transform 0.1s;
  }
  .rss-btn:hover { background: var(--red-light); transform: translateY(-1px); }

  .feed-url-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--bg);
    border: 1px solid var(--border-bright);
    border-radius: 6px;
    padding: 0.45rem 0.625rem;
    overflow: hidden;
  }
  .feed-url-row code {
    font-family: 'Instrument Sans', monospace;
    font-size: 0.7rem;
    color: var(--amber);
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .copy-btn-sm {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    padding: 0.125rem;
    transition: color 0.15s;
    flex-shrink: 0;
  }
  .copy-btn-sm:hover { color: var(--text-muted); }
  .copy-btn-sm.copied { color: #4EC994; }

  .feed-types {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.375rem;
  }
  .feed-types-label {
    font-size: 0.75rem;
    color: var(--text-dim);
  }
  .feed-type-pill {
    padding: 0.2rem 0.5rem;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 999px;
    font-size: 0.75rem;
    font-family: 'Instrument Sans', monospace;
    color: var(--text-muted);
    transition: all 0.15s;
  }
  .feed-type-pill:hover { border-color: var(--amber); color: var(--amber); background: var(--amber-dim); }

  /* ── Posts ── */
  .posts-section { padding: 3rem 2rem; }
  .posts-inner { max-width: var(--max-w); margin: 0 auto; }

  .posts-header {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .posts-header h2 {
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  .posts-count {
    font-size: 0.8125rem;
    color: var(--text-dim);
  }
  .no-posts {
    color: var(--text-muted);
    font-style: italic;
    padding: 2rem 0;
  }

  .post-list {
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .post-item {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    transition: background 0.12s;
  }
  .post-item:last-child { border-bottom: none; }
  .post-item:hover { background: var(--surface); }
  .post-item:hover .post-arrow { opacity: 1; color: var(--red); }
  .post-item:hover .post-title { color: var(--red-light); }

  .post-index {
    font-family: 'Syne', sans-serif;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-dim);
    min-width: 1.75rem;
    flex-shrink: 0;
  }
  .post-body { flex: 1; min-width: 0; }
  .post-title {
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.12s;
  }
  .post-meta {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8rem;
    color: var(--text-dim);
  }
  .post-tag { color: var(--amber); font-family: 'Instrument Sans', monospace; }
  .post-sep { color: var(--border-bright); }
  .post-arrow {
    font-size: 0.875rem;
    color: var(--text-dim);
    opacity: 0;
    transition: all 0.12s;
    flex-shrink: 0;
  }

  /* ── Responsive ── */
  @media (max-width: 768px) {
    .author-header-inner {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    .author-right { min-width: unset; }
    .author-stats { justify-content: center; }
  }
  @media (max-width: 560px) {
    .author-header-inner { padding: 1.5rem 1.25rem 2rem; }
    .posts-section { padding: 2.5rem 1.25rem; }
    .author-left { flex-direction: column; align-items: center; text-align: center; }
    .author-bio { text-align: left; }
    .author-meta { justify-content: center; }
  }
</style>
